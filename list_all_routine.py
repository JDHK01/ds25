#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
list_all_routine.py

éå†plan_manual.pyä¸­çš„coordinate_listï¼Œä½¿ç”¨plan_pro_max.pyåˆ†æåï¼Œ
å€ŸåŠ©visual.pyè¿›è¡Œå¯è§†åŒ–åˆ†æå¹¶å°†å›¾ç‰‡ä¿å­˜åˆ°/pictureæ–‡ä»¶å¤¹ã€‚

Author: Generated by Claude Code
Date: 2025-08-01
"""

import os
import sys
from pathlib import Path

# æ·»åŠ gcæ–‡ä»¶å¤¹åˆ°Pythonè·¯å¾„
gc_path = os.path.join(os.path.dirname(__file__), 'gc')
sys.path.insert(0, gc_path)

# å¯¼å…¥å¿…è¦çš„æ¨¡å—
from plan_manual import coordinate_list
from plan_pro_max import get_mapping_result
from visual import visualize_grid_navigation
import matplotlib.pyplot as plt

def ensure_picture_directory():
    """ç¡®ä¿pictureç›®å½•å­˜åœ¨"""
    picture_dir = Path('./picture')
    picture_dir.mkdir(exist_ok=True)
    return picture_dir

def save_visualization(coord_set, index, route_path, picture_dir):
    """
    ä¿å­˜å¯è§†åŒ–å›¾ç‰‡
    
    å‚æ•°:
    coord_set: åæ ‡é›†åˆï¼ˆ3ä¸ªå…ƒç´ çš„åˆ—è¡¨ï¼‰
    index: ç´¢å¼•ç¼–å·
    route_path: è·¯å¾„è§„åˆ’ç»“æœ
    picture_dir: å›¾ç‰‡ä¿å­˜ç›®å½•
    """
    try:
        # åˆ›å»ºå¯è§†åŒ–å›¾å½¢
        fig, ax = visualize_grid_navigation(coord_set, route_path)
        
        # è®¾ç½®å›¾ç‰‡æ ‡é¢˜ï¼ŒåŒ…å«è¾“å…¥åæ ‡ä¿¡æ¯
        coord_str = "_".join(coord_set)
        plt.suptitle(f'Route #{index+1}: {coord_str}', fontsize=16, fontweight='bold')
        
        # ä¿å­˜å›¾ç‰‡
        filename = f'route_{index+1:03d}_{coord_str}.png'
        filepath = picture_dir / filename
        
        plt.savefig(filepath, dpi=300, bbox_inches='tight', facecolor='white')
        plt.close(fig)  # é‡Šæ”¾å†…å­˜
        
        return filepath
        
    except Exception as e:
        print(f"ä¿å­˜å›¾ç‰‡æ—¶å‡ºé”™ (ç´¢å¼• {index}): {e}")
        return None

def analyze_coordinate_set(coord_set, index):
    """
    åˆ†æå•ä¸ªåæ ‡é›†åˆ
    
    å‚æ•°:
    coord_set: 3ä¸ªå…ƒç´ çš„åæ ‡åˆ—è¡¨
    index: ç´¢å¼•ç¼–å·
    
    è¿”å›:
    tuple: (è·¯å¾„è§„åˆ’ç»“æœ, åˆ†æä¿¡æ¯)
    """
    print(f"\nå¤„ç†ç¬¬ {index+1} ä¸ªåæ ‡é›†åˆ: {coord_set}")
    
    # ä½¿ç”¨plan_pro_max.pyåˆ†æ
    route_path = get_mapping_result(coord_set)
    
    if route_path is None:
        print(f"  âŒ æœªæ‰¾åˆ°å¯¹åº”çš„è·¯å¾„è§„åˆ’ç»“æœ")
        return None, {"status": "failed", "reason": "no_mapping_found"}
    
    # åˆ†æç»“æœ
    analysis_info = {
        "status": "success",
        "input_coordinates": coord_set,
        "path_length": len(route_path),
        "start_point": route_path[0] if route_path else None,
        "end_point": route_path[-1] if route_path else None,
        "unique_points": len(set(route_path)) if route_path else 0
    }
    
    print(f"  âœ… è·¯å¾„è§„åˆ’æˆåŠŸ")
    print(f"     è·¯å¾„é•¿åº¦: {analysis_info['path_length']} ä¸ªç‚¹")
    print(f"     èµ·ç‚¹: {analysis_info['start_point']}")
    print(f"     ç»ˆç‚¹: {analysis_info['end_point']}")
    print(f"     ç‹¬ç‰¹ç‚¹æ•°: {analysis_info['unique_points']}")
    
    return route_path, analysis_info

def generate_summary_report(all_analyses, picture_dir):
    """
    ç”Ÿæˆæ€»ç»“æŠ¥å‘Š
    
    å‚æ•°:
    all_analyses: æ‰€æœ‰åˆ†æç»“æœçš„åˆ—è¡¨
    picture_dir: å›¾ç‰‡ä¿å­˜ç›®å½•
    """
    report_path = picture_dir / 'analysis_summary.txt'
    
    successful_analyses = [a for a in all_analyses if a['status'] == 'success']
    failed_analyses = [a for a in all_analyses if a['status'] == 'failed']
    
    with open(report_path, 'w', encoding='utf-8') as f:
        f.write("è·¯å¾„è§„åˆ’åˆ†ææ€»ç»“æŠ¥å‘Š\n")
        f.write("=" * 50 + "\n\n")
        
        f.write(f"æ€»å¤„ç†æ•°é‡: {len(all_analyses)}\n")
        f.write(f"æˆåŠŸæ•°é‡: {len(successful_analyses)}\n")
        f.write(f"å¤±è´¥æ•°é‡: {len(failed_analyses)}\n\n")
        
        if successful_analyses:
            f.write("æˆåŠŸæ¡ˆä¾‹ç»Ÿè®¡:\n")
            f.write("-" * 30 + "\n")
            
            path_lengths = [a['path_length'] for a in successful_analyses]
            f.write(f"è·¯å¾„é•¿åº¦èŒƒå›´: {min(path_lengths)} - {max(path_lengths)}\n")
            f.write(f"å¹³å‡è·¯å¾„é•¿åº¦: {sum(path_lengths) / len(path_lengths):.1f}\n\n")
            
            unique_points = [a['unique_points'] for a in successful_analyses]
            f.write(f"ç‹¬ç‰¹ç‚¹æ•°èŒƒå›´: {min(unique_points)} - {max(unique_points)}\n")
            f.write(f"å¹³å‡ç‹¬ç‰¹ç‚¹æ•°: {sum(unique_points) / len(unique_points):.1f}\n\n")
        
        if failed_analyses:
            f.write("å¤±è´¥æ¡ˆä¾‹:\n")
            f.write("-" * 30 + "\n")
            for i, analysis in enumerate(failed_analyses, 1):
                f.write(f"{i}. {analysis.get('input_coordinates', 'Unknown')} - {analysis.get('reason', 'Unknown')}\n")
    
    print(f"\nğŸ“Š æ€»ç»“æŠ¥å‘Šå·²ä¿å­˜è‡³: {report_path}")

def main():
    """ä¸»å‡½æ•°"""
    print("å¼€å§‹å¤„ç†coordinate_listä¸­çš„æ‰€æœ‰åæ ‡é›†åˆ...")
    print(f"æ€»å…±éœ€è¦å¤„ç† {len(coordinate_list)} ä¸ªåæ ‡é›†åˆ")
    
    # ç¡®ä¿pictureç›®å½•å­˜åœ¨
    picture_dir = ensure_picture_directory()
    print(f"å›¾ç‰‡å°†ä¿å­˜åˆ°: {picture_dir.absolute()}")
    
    # å­˜å‚¨æ‰€æœ‰åˆ†æç»“æœ
    all_analyses = []
    successful_count = 0
    failed_count = 0
    
    # éå†æ‰€æœ‰åæ ‡é›†åˆ
    for index, coord_set in enumerate(coordinate_list):
        try:
            # åˆ†æåæ ‡é›†åˆ
            route_path, analysis_info = analyze_coordinate_set(coord_set, index)
            
            if route_path is not None:
                # ä¿å­˜å¯è§†åŒ–å›¾ç‰‡
                saved_path = save_visualization(coord_set, index, route_path, picture_dir)
                if saved_path:
                    analysis_info['image_path'] = str(saved_path)
                    print(f"     å›¾ç‰‡å·²ä¿å­˜: {saved_path.name}")
                    successful_count += 1
                else:
                    analysis_info['status'] = 'visualization_failed'
                    failed_count += 1
            else:
                failed_count += 1
            
            all_analyses.append(analysis_info)
            
        except Exception as e:
            print(f"  âŒ å¤„ç†ç¬¬ {index+1} ä¸ªåæ ‡é›†åˆæ—¶å‡ºé”™: {e}")
            all_analyses.append({
                "status": "failed",
                "input_coordinates": coord_set,
                "reason": f"exception: {str(e)}"
            })
            failed_count += 1
        
        # æ¯å¤„ç†10ä¸ªæ˜¾ç¤ºè¿›åº¦
        if (index + 1) % 10 == 0:
            print(f"\nğŸ“ˆ è¿›åº¦: {index + 1}/{len(coordinate_list)} ({(index + 1)/len(coordinate_list)*100:.1f}%)")
    
    # ç”Ÿæˆæ€»ç»“æŠ¥å‘Š
    generate_summary_report(all_analyses, picture_dir)
    
    # æœ€ç»ˆç»Ÿè®¡
    print("\n" + "="*60)
    print("å¤„ç†å®Œæˆï¼")
    print(f"æ€»æ•°é‡: {len(coordinate_list)}")
    print(f"æˆåŠŸ: {successful_count}")
    print(f"å¤±è´¥: {failed_count}")
    print(f"æˆåŠŸç‡: {successful_count/len(coordinate_list)*100:.1f}%")
    print(f"å›¾ç‰‡ä¿å­˜ä½ç½®: {picture_dir.absolute()}")
    print("="*60)

if __name__ == "__main__":
    main()